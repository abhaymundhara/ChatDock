<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Floating Chat Bar</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: sans-serif;
      height: 100%;
    }
    
    #chatDock {
      position: fixed;
      width: min(650px, 90vw);
      z-index: 10;
      box-sizing: border-box;
      transition: left 0.1s ease, top 0.1s ease;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }
    
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 8px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 100px;
      max-height: calc(80vh - 68px);
    }
    
    #chatMessages::-webkit-scrollbar {
      width: 8px;
    }
    #chatMessages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    #chatMessages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    #chatMessages::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    .chat-bar-container {
      position: relative;
      width: 100%;
    }
    
    .chat-bar {
      flex-direction: column;
      gap: 8px;
      height: 52px;
      display: flex;
      align-items: center;
      background: rgba(20, 20, 20, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: white;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: 32px;
      box-shadow: 0 0 40px rgba(0, 50, 255, 0.2), 0 0 80px rgba(0, 50, 255, 0.15);
      width: 100%;
      padding: 0 16px;
      min-height: 52px;
      position: relative;
      box-sizing: border-box;
      transition: box-shadow 0.3s ease;
    }
    
    .chat-bar.dragging {
      box-shadow: 0 0 60px rgba(0, 50, 255, 0.4), 0 0 120px rgba(0, 50, 255, 0.3);
    }
    
    .chat-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 20px;
      background: transparent;
      caret-color: #7aa2ff;
      color: #ffffff;
      font-family: inherit;
      height: auto;
      line-height: 1.5;
      padding: 12px 0;
      cursor: text;
    }
    
    .typing-indicator {
      display: none !important;
      position: absolute;
      height: 35px;
      width: 6px;
      background-color: rgba(0, 50, 255, 0.6);
      opacity: 0.5;
      border-radius: 2px;
      bottom: 8px;
      animation: typing-grow-shrink 1.2s ease-in-out infinite;
      transition: left 0.1s ease;
      pointer-events: none;
    }
    
    @keyframes typing-grow-shrink {
      0% { height: 0; opacity: 0; }
      20% { height: 35px; opacity: 1; }
      60% { height: 35px; opacity: 1; }
      100% { height: 0; opacity: 0; }
    }

    .app-type-indicator {
      font-size: 10px;
      margin-left: 4px;
      opacity: 0.7;
    }
    
    .chat-input-wrapper {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
    }
    
    .model-select {
      -webkit-app-region: no-drag;
      margin-left: 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(20, 20, 20, 0.85);
      color: #eaeaea;
      height: 32px;
      padding: 0 8px;
      outline: none;
      font-size: 12px;
      cursor: pointer;
    }
    
    #scrollToTop {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      padding: 8px 16px;
      cursor: pointer;
      background: rgba(0, 50, 255, 0.2);
      color: white;
      border-radius: 20px;
      display: none;
      z-index: 11;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    
    #scrollToTop:hover {
      background: rgba(0, 50, 255, 0.3);
      transform: translateX(-50%) translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .jump-to-latest {
      position: absolute;
      right: 12px;
      bottom: 8px;
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(20, 20, 20, 0.85);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      color: #eaeaea;
      cursor: pointer;
      display: none;
      user-select: none;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 11;
    }
    
    .jump-to-latest:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    
    .drag-button {
      position: absolute;
      left: -32px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      border-radius: 50%;
      background: rgba(20, 20, 20, 0.85);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: all 0.2s ease;
      -webkit-app-region: drag;
      cursor: grab;
    }
    
    .drag-button:hover {
      background: rgba(40, 40, 40, 0.95);
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 0 20px rgba(0, 50, 255, 0.3);
    }
    
    .drag-button img {
      width: 18px;
      height: 18px;
      object-fit: contain;
      filter: brightness(0.8);
    }
    
    .drag-button:hover img {
      filter: brightness(1);
    }
    
    .chat-input-wrapper,
    .chat-input,
    #chatMessages {
      -webkit-app-region: no-drag;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    
    .message-bubble {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 16px;
      color: #f5f7ff;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease-out;
      word-wrap: break-word;
      position: relative;
    }
    
    .message-bubble.ai { padding-right: 12px; }
    .msg-copy {
      display: inline-flex;
      position: static;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      margin-top: 6px;
      margin-left: 8px;
      float: right;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      opacity: 0.75;
      transition: opacity .15s, transform .15s;
    }
    
    .msg-copy:hover { opacity: 0.85; transform: translateY(-1px); }
    .msg-copy svg { width: 100%; height: 100%; fill: white; }
    .msg-copy:active { transform: translateY(0); }
    
    .message-bubble.user {
      align-self: flex-end;
      background: rgba(0, 50, 255, 0.24);
    }
    
    .message-bubble.ai {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.14);
    }
    
    .message-bubble.ai::after {
      content: "";
      display: block;
      clear: both;
    }
    
    .message-bubble.ai {
      white-space: pre-wrap;
      line-height: 1.5;
    }
    
    .message-bubble.ai p { margin: 0.5em 0; }
    .message-bubble.ai code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.95em;
      background: rgba(255,255,255,0.06);
      padding: 0.15em 0.35em;
      border-radius: 4px;
    }
    
    .message-bubble.ai pre {
      position: relative;
      margin: 0.75rem 0;
      padding: 0.75rem 0.9rem 0.9rem;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      overflow-x: auto;
      -webkit-app-region: no-drag;
    }
    
    .message-bubble.ai pre code {
      background: transparent;
      padding: 0;
      font-size: 0.92em;
      display: block;
    }
    
    .code-copy {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(20,20,20,0.85);
      color: #eaeaea;
      cursor: pointer;
      user-select: none;
    }
    
    .code-copy:active { transform: translateY(1px); }
    .message-bubble.ai a {
      color: #9bd3ff;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="chatDock">
    <div id="scrollToTop">↑ Scroll to First Message</div>
    <div id="chatMessages"></div>
    <button id="jumpLatest" class="jump-to-latest" title="Jump to latest">Jump to latest ↓</button>
    <div class="chat-bar-container">
      <div class="chat-bar" id="chatBar">
        <div class="drag-button" id="dragButton">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 19h2V5H7v14zm4-14v14h2V5h-2zm4 0v14h2V5h-2z'/%3E%3C/svg%3E" alt="Drag" />
        </div>
        <div class="chat-input-wrapper">
          <input type="text" class="chat-input" id="chatInput" autofocus />
          <div class="typing-indicator"></div>
          <select id="modelSelect" class="model-select" title="Select Ollama model">
            <option disabled>Loading models…</option>
          </select>
        </div>
      </div>
    </div>
  </div>

<script>
// === CONFIGURATION ===
const useAI = true;
const CHAT_BASE = (window.__CHAT_BASE__ && window.__CHAT_BASE__.get && window.__CHAT_BASE__.get()) || 'http://127.0.0.1:3001';
const CHAT_ENDPOINT = `${CHAT_BASE}/chat`;
const MODELS_ENDPOINT = `${CHAT_BASE}/models`;

// === UI COMPONENT HOOKS ===
const input = document.getElementById('chatInput');
const messages = document.getElementById('chatMessages');
const indicator = document.querySelector('.typing-indicator');
const dock = document.getElementById('chatDock');
const chatBar = document.getElementById('chatBar');
const dragButton = document.getElementById('dragButton');
const jumpBtn = document.getElementById('jumpLatest');
const scrollToTopBtn = document.getElementById('scrollToTop');
const modelSelect = document.getElementById('modelSelect');


// --- Auto-scroll management ---
let shouldAutoScroll = true;

messages.addEventListener('scroll', () => {
  const scrollBottom = messages.scrollHeight - messages.clientHeight - messages.scrollTop;
  shouldAutoScroll = scrollBottom < 50;
  
  if (jumpBtn) {
    jumpBtn.style.display = shouldAutoScroll ? 'none' : 'block';
  }
});

if (jumpBtn) {
  jumpBtn.addEventListener('click', () => {
    messages.scrollTop = messages.scrollHeight;
    shouldAutoScroll = true;
    jumpBtn.style.display = 'none';
  });
}

if (scrollToTopBtn) {
  scrollToTopBtn.addEventListener('click', () => {
    messages.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
    shouldAutoScroll = false;
  });
}

// Caret position indicator
const updateIndicatorPosition = () => {
  const caretPos = input.selectionStart;
  const tempSpan = document.createElement('span');
  tempSpan.textContent = input.value.substring(0, caretPos);
  tempSpan.style.visibility = 'hidden';
  tempSpan.style.position = 'absolute';
  tempSpan.style.font = window.getComputedStyle(input).font;
  tempSpan.style.whiteSpace = 'pre';
  document.querySelector('.chat-input-wrapper').appendChild(tempSpan);
  const caretX = tempSpan.offsetWidth;
  document.querySelector('.chat-input-wrapper').removeChild(tempSpan);
  indicator.style.left = `${caretX + 4}px`;
};

input.addEventListener('input', updateIndicatorPosition);
input.addEventListener('click', updateIndicatorPosition);
input.addEventListener('keyup', updateIndicatorPosition);
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const text = input.value.trim();
    if (text) {
      handleSubmit(text);
    }
  }
});

// Add this to the window.onload function in index.html
window.onload = () => {
  input.focus();
  setTimeout(updateIndicatorPosition, 0);
  centerDock();
  initModels();
};

function centerDock() {
  dock.style.left = (window.innerWidth / 2 - dock.offsetWidth / 2) + 'px';
  dock.style.top = (window.innerHeight / 2 - dock.offsetHeight / 2) + 'px';
}

// Attach a minimal copy button to a message bubble
function attachMessageCopy(bubble) {
  if (!bubble || bubble.querySelector('.msg-copy')) return;

  const btn = document.createElement('button');
  btn.className = 'msg-copy';
  btn.type = 'button';
  btn.title = 'Copy response';

  btn.innerHTML = `
   <svg xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="white"
        width="12"
        height="12">
     <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/>
   </svg>`;

  btn.addEventListener('click', () => {
    const txt = bubble.innerText || bubble.textContent || '';
    navigator.clipboard.writeText(txt.trim())
      .then(() => {
        btn.style.opacity = 1;
        setTimeout(() => (btn.style.opacity = 0.75), 600);
      })
      .catch(() => {});
  });

  bubble.insertAdjacentElement('beforeend', btn);
}

// === FUNCTIONAL LAYER ===
function createMessageBubble(text, role) {
  const bubble = document.createElement('div');
  bubble.className = `message-bubble ${role}`;
  bubble.textContent = text;
  if (role === 'ai') {
    attachMessageCopy(bubble);
  }
  return bubble;
}

async function handleSubmit(text) {
  if (!text.trim()) return;
  input.value = '';

  // Add user message
  const userBubble = createMessageBubble(text, 'user');
  messages.appendChild(userBubble);
  if (shouldAutoScroll) {
    messages.scrollTop = messages.scrollHeight;
  }

  if (!useAI) {
    const aiBubble = createMessageBubble('Thinking about: "' + text + '"...', 'ai');
    messages.appendChild(aiBubble);
    if (shouldAutoScroll) {
      messages.scrollTop = messages.scrollHeight;
    }
    return;
  }

  // Create AI response bubble
  const aiBubble = createMessageBubble('...', 'ai');
  messages.appendChild(aiBubble);
  if (shouldAutoScroll) {
    messages.scrollTop = messages.scrollHeight;
  }

  try {
    const selectedModel = modelSelect ? modelSelect.value : '';
    const resp = await fetch(CHAT_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, model: selectedModel }),
    });

    if (!resp.ok || !resp.body) {
      aiBubble.textContent = `⚠️ Backend error: ${resp.status} ${resp.statusText}. Falling back…`;
      aiBubble.textContent += `\nThinking about: "${text}"...`;
      return;
    }

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let done = false;
    let aiText = '';
    
    while (!done) {
      const { value, done: doneReading } = await reader.read();
      done = doneReading;
      if (value) {
        aiText += decoder.decode(value, { stream: !done });
        aiBubble.textContent = aiText;
        if (shouldAutoScroll) {
          messages.scrollTop = messages.scrollHeight;
        }
      }
    }
    finalizeAIBubble(aiBubble);
    attachMessageCopy(aiBubble);
  } catch (err) {
    console.error('AI Error:', err);
    aiBubble.textContent = `⚠️ AI unavailable. Thinking about: "${text}"...`;
    if (shouldAutoScroll) {
      messages.scrollTop = messages.scrollHeight;
    }
  }
}

// === MODEL PICKER LOGIC ===
async function initModels() {
  try {
    const r = await fetch(MODELS_ENDPOINT);
    const data = await r.json();
    const models = Array.isArray(data.models) ? data.models : [];
    const preferred = localStorage.getItem('preferred_model');
    modelSelect.innerHTML = '';
    if (models.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = 'No local models found';
      opt.disabled = true;
      opt.selected = true;
      modelSelect.appendChild(opt);
      modelSelect.disabled = true;
      return;
    }
    for (const name of models) {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      modelSelect.appendChild(opt);
    }
    if (preferred && models.includes(preferred)) {
      modelSelect.value = preferred;
    } else {
      modelSelect.value = models[0];
      localStorage.setItem('preferred_model', modelSelect.value);
    }
    modelSelect.addEventListener('change', () => {
      localStorage.setItem('preferred_model', modelSelect.value);
    });
  } catch (e) {
    modelSelect.innerHTML = '';
    const opt = document.createElement('option');
    opt.textContent = 'Model picker offline';
    opt.disabled = true;
    opt.selected = true;
    modelSelect.appendChild(opt);
    console.error('Failed to load models:', e);
  }
}

// --- Minimal Markdown Renderer (safe) ---
function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function renderMarkdown(md) {
  if (!md) return "";
  md = md.replace(/\r\n?/g, "\n");

  let fenceId = 0;
  const fences = {};
  md = md.replace(/```(\w+)?\n([\s\S]*?)```/g, (_m, lang, code) => {
    const key = `__FENCE_${fenceId++}__`;
    fences[key] = { lang: (lang || "").trim(), code };
    return key;
  });

  md = escapeHtml(md);

  md = md.replace(/`([^`]+)`/g, (_m, c) => `<code>${c}</code>`);
  md = md.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  md = md.replace(/\*([^*]+)\*/g, "<em>$1</em>");
  md = md.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (_m, txt, url) => {
    const t = escapeHtml(txt);
    const u = escapeHtml(url);
    return `<a href="${u}" target="_blank" rel="noopener noreferrer">${t}</a>`;
  });
  md = md.replace(/(?:^|\n)[ \t]*[-*][ \t]+(.+)(?=\n|$)/g, (_m, item) => `\n• ${item}`);

  const parts = md.split(/\n{2,}/).map(block => `<p>${block.replace(/\n/g, "<br/>")}</p>`).join("");

  let html = parts;
  Object.entries(fences).forEach(([key, obj]) => {
    const codeEsc = escapeHtml(obj.code);
    const langAttr = obj.lang ? ` data-lang="${obj.lang}"` : "";
    const block = `<pre><button class="code-copy" data-copy>Copy</button><code${langAttr}>${codeEsc}</code></pre>`;
    html = html.replace(key, block);
  });

  return html;
}

function finalizeAIBubble(bubble) {
  if (!bubble) return;
  const raw = bubble.textContent;
  const rendered = renderMarkdown(raw);
  bubble.innerHTML = rendered;
  
  bubble.querySelectorAll('button.code-copy[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => {
      const code = btn.parentElement.querySelector('code')?.innerText || '';
      if (!code) return;
      navigator.clipboard.writeText(code).then(() => {
        const old = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = old), 900);
      }).catch(() => {});
    });
  });
}

// Simple dragging functionality
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

dragButton.addEventListener('mousedown', (e) => {
  if (e.target.closest('.drag-button')) {
    isDragging = true;
    dragOffset.x = e.clientX - dock.offsetLeft;
    dragOffset.y = e.clientY - dock.offsetTop;
    chatBar.classList.add('dragging');
    e.preventDefault();
  }
});

document.addEventListener('mousemove', (e) => {
  if (isDragging) {
    const newX = e.clientX - dragOffset.x;
    const newY = e.clientY - dragOffset.y;
    
    const maxX = window.innerWidth - dock.offsetWidth;
    const maxY = window.innerHeight - dock.offsetHeight;
    
    dock.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
    dock.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
  }
});

document.addEventListener('mouseup', () => {
  if (isDragging) {
    isDragging = false;
    chatBar.classList.remove('dragging');
  }
});
</script>
</body>
</html>
